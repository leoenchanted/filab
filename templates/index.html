<!DOCTYPE html>
<html lang="zh" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRO FILM LAB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        .selected-card { border: 2px solid #bb86fc !important; background: rgba(187, 134, 252, 0.1) !important; }
        .shimmer::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); animation: shim 1.5s infinite; }
        @keyframes shim { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
    </style>
</head>
<body class="bg-[#0a0a0a] text-zinc-100 min-h-screen p-4 pb-20">

    <header class="py-8 text-center border-b border-zinc-900 mb-8">
        <h1 class="text-xl tracking-[0.4em] font-light">PRO FILM LAB</h1>
    </header>

    <main class="max-w-4xl mx-auto">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-8">
            <div onclick="selectFilm(this, 'fuji')" class="film-card selected-card bg-zinc-900 p-4 rounded-xl border border-zinc-800 cursor-pointer">
                <div class="text-sm font-bold">Fuji 400H</div>
                <div class="text-[10px] text-purple-400">日系通透</div>
            </div>
            <div onclick="selectFilm(this, 'kodak')" class="film-card bg-zinc-900 p-4 rounded-xl border border-zinc-800 cursor-pointer">
                <div class="text-sm font-bold">Portra 400</div>
                <div class="text-[10px] text-orange-400">温暖肤色</div>
            </div>
            <div onclick="selectFilm(this, 'cinestill')" class="film-card bg-zinc-900 p-4 rounded-xl border border-zinc-800 cursor-pointer">
                <div class="text-sm font-bold">800T</div>
                <div class="text-[10px] text-cyan-400">电影夜景</div>
            </div>
            <div onclick="selectFilm(this, 'ricoh')" class="film-card bg-zinc-900 p-4 rounded-xl border border-zinc-800 cursor-pointer">
                <div class="text-sm font-bold">Ricoh GR</div>
                <div class="text-[10px] text-zinc-400">森山黑白</div>
            </div>
            <div onclick="selectFilm(this, 'polaroid')" class="film-card bg-zinc-900 p-4 rounded-xl border border-zinc-800 cursor-pointer">
                <div class="text-sm font-bold">Polaroid</div>
                <div class="text-[10px] text-yellow-500">复古怀旧</div>
            </div>
            <div onclick="selectFilm(this, 'ilford')" class="film-card bg-zinc-900 p-4 rounded-xl border border-zinc-800 cursor-pointer">
                <div class="text-sm font-bold">HP5 Plus</div>
                <div class="text-[10px] text-blue-400">经典黑白</div>
            </div>
        </div>

        <div class="bg-zinc-900 rounded-3xl p-6 border border-zinc-800 shadow-xl">
            <div id="imageInfo" class="hidden bg-black/40 p-4 rounded-xl mb-6 text-xs border-l-2 border-purple-500 space-y-2">
                <div class="flex justify-between"><span>原始分辨率</span><span id="originalSize" class="text-zinc-400 font-mono"></span></div>
                <div class="flex justify-between"><span>处理分辨率</span><span id="processedSize" class="text-emerald-500 font-mono"></span></div>
                <div class="flex justify-between"><span>预计时间</span><span id="estimatedTime" class="text-emerald-500 font-mono"></span></div>
            </div>

            <div class="flex items-center gap-4 mb-6">
                <label class="text-xs text-zinc-500">颗粒强度</label>
                <select id="grainSelect" class="flex-1 bg-black border border-zinc-800 rounded-lg p-2 text-sm outline-none focus:border-purple-500">
                    <option value="off">Off</option><option value="low">Low</option><option value="normal" selected>Normal</option><option value="high">High</option>
                </select>
            </div>

            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect()">
            <div class="flex gap-3">
                <button onclick="document.getElementById('fileInput').click()" class="flex-1 py-4 bg-zinc-800 rounded-full font-bold text-sm">选择照片</button>
                <button id="processBtn" disabled onclick="processImage()" class="flex-1 py-4 bg-purple-600 disabled:bg-zinc-800 disabled:text-zinc-600 rounded-full font-bold text-sm text-black transition-all">开始冲洗</button>
            </div>

            <div id="progressContainer" class="hidden mt-8">
                <div class="h-1.5 w-full bg-black rounded-full overflow-hidden relative">
                    <div id="progressFill" class="h-full bg-gradient-to-r from-purple-500 to-emerald-400 w-0 transition-all duration-300 shimmer relative"></div>
                </div>
                <div class="flex justify-between mt-3 text-[10px] tracking-widest text-zinc-500 uppercase">
                    <span id="progressStatus">Ready</span>
                    <span id="progressPercent" class="text-purple-400">0%</span>
                </div>
            </div>
            <div id="statusText" class="mt-4 text-center text-[10px] text-zinc-600"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
            <div class="aspect-square bg-zinc-950 rounded-2xl border border-zinc-900 overflow-hidden relative">
                <img id="imgOriginal" class="w-full h-full object-contain opacity-0 transition-opacity">
                <div class="absolute top-2 left-2 px-2 py-1 bg-black/60 text-[8px] rounded">BEFORE</div>
            </div>
            <div class="aspect-square bg-zinc-950 rounded-2xl border border-zinc-900 overflow-hidden relative">
                <img id="imgResult" class="w-full h-full object-contain opacity-0 transition-opacity">
                <div class="absolute top-2 left-2 px-2 py-1 bg-black/60 text-[8px] rounded">AFTER</div>
            </div>
        </div>

        <div id="downloadSection" class="hidden mt-8 text-center">
            <a id="downloadLink" href="#" download class="inline-block bg-emerald-500 text-black px-10 py-4 rounded-full font-bold shadow-lg shadow-emerald-500/20">保存成片</a>
        </div>
    </main>

    <script>
        let currentStyle = 'fuji';
        let sessionId = null;
        const socket = io();

        socket.on('image_analysis', data => {
            if(data.session_id !== sessionId) return;
            document.getElementById('imageInfo').classList.remove('hidden');
            document.getElementById('originalSize').innerText = `${data.original.width}x${data.original.height}`;
            document.getElementById('processedSize').innerText = `${data.processed.width}x${data.processed.height}`;
            document.getElementById('estimatedTime').innerText = `${data.estimated_time}s`;
        });

        socket.on('progress_update', data => {
            if(data.session_id !== sessionId) return;
            document.getElementById('progressFill').style.width = data.progress + '%';
            document.getElementById('progressPercent').innerText = data.progress + '%';
            document.getElementById('progressStatus').innerText = data.message;
        });

        function selectFilm(el, style) {
            document.querySelectorAll('.film-card').forEach(c => c.classList.remove('selected-card'));
            el.classList.add('selected-card');
            currentStyle = style;
        }

        function handleFileSelect() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return;
            document.getElementById('imgOriginal').src = URL.createObjectURL(file);
            document.getElementById('imgOriginal').classList.add('opacity-100');
            document.getElementById('processBtn').disabled = false;
            document.getElementById('imageInfo').classList.add('hidden');
            document.getElementById('downloadSection').classList.add('hidden');
            document.getElementById('imgResult').classList.remove('opacity-100');
        }

        async function processImage() {
            const file = document.getElementById('fileInput').files[0];
            sessionId = 'id_' + Date.now();
            
            document.getElementById('processBtn').disabled = true;
            document.getElementById('progressContainer').classList.remove('hidden');
            
            const fd = new FormData();
            fd.append('file', file);
            fd.append('style', currentStyle);
            fd.append('grain', document.getElementById('grainSelect').value);
            fd.append('session_id', sessionId);

            try {
                const res = await fetch('/process', { method: 'POST', body: fd });
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                
                const img = document.getElementById('imgResult');
                img.src = url;
                img.onload = () => {
                    img.classList.add('opacity-100');
                    document.getElementById('statusText').innerText = `处理完成 | 耗时 ${res.headers.get('X-Processing-Time')}s`;
                    document.getElementById('processBtn').disabled = false;
                    document.getElementById('downloadLink').href = url;
                    document.getElementById('downloadLink').download = `film_${Date.now()}.jpg`;
                    document.getElementById('downloadSection').classList.remove('hidden');
                }
            } catch(e) {
                alert('处理失败');
                document.getElementById('processBtn').disabled = false;
            }
        }
    </script>
</body>
</html>
