<!DOCTYPE html>
<html lang="zh" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRO FILM LAB | æç®€æš—æˆ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* éƒ¨åˆ† Tailwind æ— æ³•ç›´æ¥å¤„ç†çš„åŠ¨ç”»å’Œè‡ªå®šä¹‰æ ·å¼ */
        .shimmer::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
        
        .selected-card { border: 2px solid #bb86fc !important; background: rgba(187, 134, 252, 0.1) !important; }
        
        body { background-color: #0d0d0d; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="text-gray-100 min-h-screen p-4 md:p-8">

    <div id="connectionStatus" class="fixed top-4 right-4 z-50 px-3 py-1 rounded-full bg-zinc-800 text-[10px] text-gray-400 hidden">
        <span id="connectionText">â— è¿æ¥ä¸­</span>
    </div>

    <header class="max-w-4xl mx-auto text-center mb-10 border-b border-zinc-800 pb-6">
        <h1 class="text-2xl md:text-3xl font-light tracking-[0.3em] uppercase">Film Lab <span class="text-xs align-top text-zinc-500 font-sans">Mobile</span></h1>
    </header>

    <main class="max-w-5xl mx-auto">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
            <div onclick="selectFilm(this, 'fuji')" class="film-card selected-card bg-zinc-900 border border-zinc-800 p-4 rounded-2xl cursor-pointer hover:bg-zinc-800 transition-all">
                <div class="font-bold text-sm mb-1">Fuji Pro 400H</div>
                <div class="text-[10px] text-purple-300 bg-purple-900/30 px-2 py-0.5 rounded inline-block">æ—¥ç³» / é€šé€</div>
                <p class="text-xs text-zinc-500 mt-2 hidden md:block">é’è‰²é˜´å½±ï¼Œé€šé€é«˜å…‰ï¼Œé€‚åˆé£æ™¯ä¸äººåƒã€‚</p>
            </div>
            <div onclick="selectFilm(this, 'kodak')" class="film-card bg-zinc-900 border border-zinc-800 p-4 rounded-2xl cursor-pointer hover:bg-zinc-800 transition-all">
                <div class="font-bold text-sm mb-1">Kodak Portra</div>
                <div class="text-[10px] text-orange-300 bg-orange-900/30 px-2 py-0.5 rounded inline-block">äººåƒ / æš–è°ƒ</div>
                <p class="text-xs text-zinc-500 mt-2 hidden md:block">è‚¤è‰²è¿˜åŸæä½³ï¼Œè‰²è°ƒæ¸©æš–ç»†è…»ã€‚</p>
            </div>
            <div onclick="selectFilm(this, 'cinestill')" class="film-card bg-zinc-900 border border-zinc-800 p-4 rounded-2xl cursor-pointer hover:bg-zinc-800 transition-all">
                <div class="font-bold text-sm mb-1">Cinestill 800T</div>
                <div class="text-[10px] text-cyan-300 bg-cyan-900/30 px-2 py-0.5 rounded inline-block">å¤œæ™¯ / ç”µå½±æ„Ÿ</div>
                <p class="text-xs text-zinc-500 mt-2 hidden md:block">æ ‡å¿—æ€§çš„çº¢è‰²å…‰æ™•ï¼Œè¿·äººçš„æš—éƒ¨è‰²è°ƒã€‚</p>
            </div>
            <div onclick="selectFilm(this, 'ricoh')" class="film-card bg-zinc-900 border border-zinc-800 p-4 rounded-2xl cursor-pointer hover:bg-zinc-800 transition-all">
                <div class="font-bold text-sm mb-1">Ricoh GR</div>
                <div class="text-[10px] text-gray-300 bg-zinc-700 px-2 py-0.5 rounded inline-block">é«˜åå·® / é»‘ç™½</div>
                <p class="text-xs text-zinc-500 mt-2 hidden md:block">è‡´æ•¬æ£®å±±å¤§é“ï¼Œç²—é¢—ç²’æè‡´é»‘ç™½ã€‚</p>
            </div>
            <div onclick="selectFilm(this, 'polaroid')" class="film-card bg-zinc-900 border border-zinc-800 p-4 rounded-2xl cursor-pointer hover:bg-zinc-800 transition-all">
                <div class="font-bold text-sm mb-1">Polaroid</div>
                <div class="text-[10px] text-yellow-300 bg-yellow-900/30 px-2 py-0.5 rounded inline-block">å¤å¤ / æŸ”å…‰</div>
                <p class="text-xs text-zinc-500 mt-2 hidden md:block">æ€€æ—§æ„Ÿåè¶³ï¼Œé»‘ä½æµ®èµ·ï¼Œè‰²è°ƒåé»„ã€‚</p>
            </div>
            <div onclick="selectFilm(this, 'ilford')" class="film-card bg-zinc-900 border border-zinc-800 p-4 rounded-2xl cursor-pointer hover:bg-zinc-800 transition-all">
                <div class="font-bold text-sm mb-1">Ilford HP5</div>
                <div class="text-[10px] text-blue-300 bg-blue-900/30 px-2 py-0.5 rounded inline-block">çºªå® / é“¶ç›</div>
                <p class="text-xs text-zinc-500 mt-2 hidden md:block">ç»å…¸çºªå®èƒ¶ç‰‡ï¼Œç°åº¦æå…¶ä¸°å¯Œã€‚</p>
            </div>
        </div>

        <div class="max-w-2xl mx-auto bg-zinc-900/50 backdrop-blur-xl border border-zinc-800 rounded-[2rem] p-6 shadow-2xl">
            <div id="imageInfo" class="hidden animate-in slide-in-from-top duration-300 bg-zinc-800/50 border-l-4 border-purple-500 p-4 rounded-xl mb-6 text-sm">
                <div class="flex justify-between mb-1"><span class="text-zinc-400">åŸå§‹å°ºå¯¸:</span><span id="originalSize" class="text-emerald-400 font-mono">-</span></div>
                <div class="flex justify-between mb-1"><span class="text-zinc-400">æœ€ç»ˆå°ºå¯¸:</span><span id="processedSize" class="text-emerald-400 font-mono">-</span></div>
                <div class="flex justify-between"><span class="text-zinc-400">é¢„è®¡è€—æ—¶:</span><span id="estimatedTime" class="text-emerald-400 font-mono">-</span></div>
            </div>

            <div class="flex items-center gap-4 mb-6">
                <label class="text-xs text-zinc-400 whitespace-nowrap">é¢—ç²’è´¨æ„Ÿ (Grain):</label>
                <select id="grainSelect" class="w-full bg-black border border-zinc-700 rounded-lg py-2 px-3 text-sm focus:border-purple-500 outline-none transition-all">
                    <option value="off">Off (æ´å‡€)</option>
                    <option value="low">Low (æŸ”å’Œ)</option>
                    <option value="normal" selected>Normal (æ ‡å‡†)</option>
                    <option value="high">High (ç²—ç³™)</option>
                </select>
            </div>

            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect()">
            <div class="flex flex-col sm:flex-row gap-4">
                <button onclick="document.getElementById('fileInput').click()" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white font-bold py-4 px-6 rounded-full transition-all flex items-center justify-center gap-2">
                    ğŸ“¸ é€‰æ‹©ç…§ç‰‡
                </button>
                <button id="processBtn" onclick="processImage()" disabled class="flex-1 bg-purple-600 disabled:bg-zinc-700 disabled:opacity-50 text-black font-bold py-4 px-6 rounded-full transition-all flex items-center justify-center gap-2">
                    âš¡ å¼€å§‹å†²æ´—
                </button>
            </div>

            <div id="progressContainer" class="hidden mt-6">
                <div class="w-full bg-zinc-800 h-2.5 rounded-full overflow-hidden relative">
                    <div id="progressFill" class="shimmer bg-gradient-to-r from-purple-500 to-emerald-400 h-full w-0 transition-all duration-300"></div>
                </div>
                <div class="flex justify-between mt-2 text-[10px] text-zinc-500 tracking-wider">
                    <span id="progressStatus">å‡†å¤‡ä¸­...</span>
                    <span id="progressPercent" class="text-purple-400 font-mono">0%</span>
                </div>
            </div>

            <div id="statusText" class="mt-4 text-center text-xs text-zinc-500 min-h-[1rem]">ç­‰å¾…ä¸Šä¼ ...</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-10">
            <div class="relative bg-black rounded-2xl overflow-hidden border border-zinc-800 min-h-[300px] flex items-center">
                <span class="absolute top-3 left-3 bg-black/50 backdrop-blur-md text-[10px] px-2 py-1 rounded z-10 text-zinc-300">Original</span>
                <img id="imgOriginal" class="w-full opacity-0 transition-opacity duration-500">
            </div>
            <div class="relative bg-black rounded-2xl overflow-hidden border border-zinc-800 min-h-[300px] flex items-center">
                <span class="absolute top-3 left-3 bg-black/50 backdrop-blur-md text-[10px] px-2 py-1 rounded z-10 text-zinc-300">Developed</span>
                <img id="imgResult" class="w-full opacity-0 transition-opacity duration-500">
            </div>
        </div>

        <div id="downloadSection" class="hidden text-center mt-10">
            <a id="downloadLink" href="#" download class="inline-flex items-center gap-2 bg-emerald-500 hover:bg-emerald-400 text-black font-bold py-4 px-8 rounded-full shadow-[0_0_20px_rgba(16,185,129,0.3)] transition-all">
                <span>â¬‡ï¸</span> ä¿å­˜é«˜æ¸…æˆç‰‡
            </a>
        </div>
    </main>

    <script>
        let currentStyle = 'fuji';
        let sessionId = null;
        let socket = null;

        function initSocket() {
            socket = io(window.location.origin);
            socket.on('connect', () => {
                document.getElementById('connectionStatus').classList.remove('hidden');
                setTimeout(() => document.getElementById('connectionStatus').classList.add('hidden'), 2000);
            });
            socket.on('image_analysis', (data) => {
                if (data.session_id === sessionId) {
                    document.getElementById('imageInfo').classList.remove('hidden');
                    document.getElementById('originalSize').textContent = `${data.original.width} Ã— ${data.original.height}`;
                    document.getElementById('processedSize').textContent = `${data.processed.width} Ã— ${data.processed.height}`;
                    document.getElementById('estimatedTime').textContent = `${data.estimated_time}s`;
                }
            });
            socket.on('progress_update', (data) => {
                if (data.session_id === sessionId) {
                    updateProgress(data.progress, data.message);
                }
            });
        }

        window.onload = initSocket;

        function selectFilm(card, style) {
            document.querySelectorAll('.film-card').forEach(c => c.classList.remove('selected-card'));
            card.classList.add('selected-card');
            currentStyle = style;
        }

        function handleFileSelect() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;
            const img = document.getElementById('imgOriginal');
            img.src = URL.createObjectURL(file);
            img.onload = () => img.classList.add('opacity-100');
            document.getElementById('processBtn').disabled = false;
            document.getElementById('statusText').innerText = "å·²å°±ç»ª";
            document.getElementById('imageInfo').classList.add('hidden');
            document.getElementById('downloadSection').classList.add('hidden');
            document.getElementById('imgResult').classList.remove('opacity-100');
        }

        function updateProgress(progress, message) {
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
            document.getElementById('progressStatus').textContent = message;
        }

        async function processImage() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) return;
            sessionId = 'sn_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('processBtn').disabled = true;
            document.getElementById('progressContainer').classList.remove('hidden');
            updateProgress(5, 'æ­£åœ¨è¯·æ±‚æœåŠ¡å™¨...');

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('style', currentStyle);
            formData.append('grain', document.getElementById('grainSelect').value);
            formData.append('session_id', sessionId);

            try {
                const res = await fetch('/process', { method: 'POST', body: formData });
                const blob = await res.blob();
                const imgRes = document.getElementById('imgResult');
                imgRes.src = URL.createObjectURL(blob);
                imgRes.onload = () => {
                    imgRes.classList.add('opacity-100');
                    updateProgress(100, 'âœ¨ å¤„ç†å®Œæˆ');
                    document.getElementById('statusText').innerHTML = `âœ… è€—æ—¶: ${res.headers.get('X-Processing-Time')}s`;
                    document.getElementById('processBtn').disabled = false;
                    
                    const link = document.getElementById('downloadLink');
                    link.href = imgRes.src;
                    link.download = `film_${currentStyle}_${Date.now()}.jpg`;
                    document.getElementById('downloadSection').classList.remove('hidden');
                };
            } catch (e) {
                document.getElementById('statusText').innerText = "âŒ å¤„ç†å¤±è´¥";
                document.getElementById('processBtn').disabled = false;
            }
        }
    </script>
</body>
</html>
